// 小程序富文本插件 https://github.com/jin-yufeng/Parser
"use strict";function _classCallCheck(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,s){for(var i=0;i<s.length;i++){var e=s[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(s,i,e){return i&&t(s.prototype,i),e&&t(s,e),s}}(),cfg=require("./config.js"),blankChar=cfg.blankChar,CssHandler=require("./CssHandler.js"),screenWidth=wx.getSystemInfoSync().screenWidth;try{var emoji=require("./emoji.js")}catch(t){}var MpHtmlParser=function(){function t(s){var i=this,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,t),this.isClose=function(){return">"==i.data[i.i]||"/"==i.data[i.i]&&">"==i.data[i.i+1]},this.section=function(){return i.data.substring(i.start,i.i)},this.siblings=function(){return i.STACK.length?i.STACK[i.STACK.length-1].children:i.DOM},this.attrs={},this.compress=e.compress,this.CssHandler=new CssHandler(e.tagStyle,screenWidth),this.data=s,this.domain=e.domain,this.DOM=[],this.i=0,this.protocol=this.domain&&this.domain.includes("://")?this.domain.split("://")[0]:"http",this.start=0,this.state=this.Text,this.STACK=[],this.audioNum=0,this.imgNum=0,this.videoNum=0,this.useAnchor=e.useAnchor}return _createClass(t,[{key:"parse",value:function(){emoji&&(this.data=emoji.parseEmoji(this.data));for(var t;t=this.data[this.i];this.i++)this.state(t);for(this.state==this.Text&&this.setText();this.STACK.length;)this.popNode(this.STACK.pop());return this.DOM.length&&(this.DOM[0].PoweredBy="Parser",this.title&&(this.DOM[0].title=this.title)),this.DOM}},{key:"setAttr",value:function(){var t=this.attrName.toLowerCase();for(cfg.trustAttrs[t]&&(this.attrVal?this.attrs[t]="src"==t?encodeURI(this.getUrl(this.attrVal)):this.attrVal:cfg.boolAttrs[t]&&(this.attrs[t]="T")),this.attrVal="";blankChar[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)}},{key:"setText",value:function(){var t,s=this.section();if(s)if(s=cfg.onText&&cfg.onText(s,function(){return t=!0})||s,t){this.data=this.data.substr(0,this.start)+s+this.data.substr(this.i);var i=this.start+s.length;for(this.i=this.start;this.i<i;this.i++)this.state(this.data[this.i])}else{if(!this.pre){for(var e,a=[],r=s.length;e=s[--r];)(!blankChar[e]||!blankChar[a[0]]&&(e=" "))&&a.unshift(e);if(" "==(s=a.join("")))return}for(var h,n,l=-1,o=this.siblings();;){if(-1==(l=s.indexOf("&",l+1)))break;if(-1==(h=s.indexOf(";",l+2)))break;"#"==s[l+1]?(n=parseInt(("x"==s[l+2]?"0":"")+s.substring(l+2,h)),isNaN(n)||(s=s.substr(0,l)+String.fromCharCode(n)+s.substr(h+1))):(n=s.substring(l+1,h),"nbsp"==n?s=s.substr(0,l)+" "+s.substr(h+1):"lt"!=n&&"gt"!=n&&"amp"!=n&&"ensp"!=n&&"emsp"!=n&&"quot"!=n&&"apos"!=n&&(l&&o.push({type:"text",text:s.substr(0,l)}),o.push({type:"text",text:"&"+n+";",en:1}),s=s.substr(h+1),l=-1))}s&&o.push({type:"text",text:s})}}},{key:"setNode",value:function(){var t={name:this.tagName.toLowerCase(),attrs:this.attrs};if(this.attrs={},cfg.ignoreTags[t.name])if(cfg.selfClosingTags[t.name])if("source"==t.name){var s=this.STACK[this.STACK.length-1],i=t.attrs;if(s&&i.src)if("video"==s.name||"audio"==s.name)s.attrs.source.push(i.src);else{var e,a=i.media;"picture"==s.name&&!s.attrs.src&&(!a||a.includes("px")&&(-1!=(e=a.indexOf("min-width"))&&-1!=(e=a.indexOf(":",e+8))&&screenWidth>parseInt(a.substr(e+1))||-1!=(e=a.indexOf("max-width"))&&-1!=(e=a.indexOf(":",e+8))&&screenWidth<parseInt(a.substr(e+1))))&&(s.attrs.src=i.src)}}else"base"!=t.name||this.domain||(this.domain=t.attrs.href);else this.remove(t);else this.matchAttr(t),cfg.selfClosingTags[t.name]?cfg.filter&&0==cfg.filter(t,this)||this.siblings().push(t):(t.children=[],"pre"==t.name&&cfg.highlight&&(this.remove(t),this.pre=t.pre=!0),this.siblings().push(t),this.STACK.push(t));"/"==this.data[this.i]&&this.i++,this.start=this.i+1,this.state=this.Text}},{key:"remove",value:function(t){for(var s=this.i;this.i<this.data.length;){for(-1==(this.i=this.data.indexOf("</",this.i+1))&&(this.i=this.data.length),this.start=this.i+=2;!blankChar[this.data[this.i]]&&!this.isClose();)this.i++;if(this.section().toLowerCase()==t.name){if("pre"==t.name)return this.data=this.data.substr(0,s+1)+cfg.highlight(this.data.substring(s+1,this.i-5),t.attrs)+this.data.substr(this.i-5),this.i=s;if("style"==t.name?this.CssHandler.getStyle(this.data.substring(s+1,this.i-7)):"title"==t.name&&(this.title=this.data.substring(s+1,this.i-7)),-1==(this.i=this.data.indexOf(">",this.i))&&(this.i=this.data.length),"svg"==t.name){var i=this.data.substring(s,this.i+1);t.attrs.xmlns||(i=' xmlns="http://www.w3.org/2000/svg"'+i);for(var e=s;"<"!=this.data[s];)s--;i=this.data.substring(s,e)+i,this.siblings().push({name:"img",attrs:{src:"data:image/svg+xml;utf8,"+i.replace(/#/g,"%23")},svg:1})}return}}}},{key:"matchAttr",value:function(t){var s=t.attrs,i=this.CssHandler.match(t.name,s,t)+(s.style||""),e={};switch(t.name){case"a":case"ad":this.bubble();break;case"font":if(s.color&&(e.color=s.color,s.color=void 0),s.face&&(e["font-family"]=s.face,s.face=void 0),s.size){var a=parseInt(s.size);a<1?a=1:a>7&&(a=7);var r=["xx-small","x-small","small","medium","large","x-large","xx-large"];e["font-size"]=r[a-1],s.size=void 0}break;case"video":case"audio":s.id?this[t.name+"Num"]++:s.id=t.name+ ++this[t.name+"Num"],"video"==t.name&&this.videoNum>3&&(t.lazyLoad=1),s.source=[],s.src&&s.source.push(s.src),s.controls||s.autoplay||console.warn("存在没有 controls 属性的 "+t.name+" 标签，可能导致无法播放",t),this.bubble()}s.align&&(e["text-align"]=s.align,s.align=void 0),s.width&&(e.width=parseFloat(s.width)+(s.width.includes("%")?"%":"px"),s.width=void 0),s.height&&(e.height=parseFloat(s.height)+(s.height.includes("%")?"%":"px"),s.height=void 0);for(var h=i.split(";"),n=0,l=h.length,i="";n<l;n++){var o=h[n].split(":");if(!(o.length<2)){var d=o[0].trim().toLowerCase(),c=o.slice(1).join(":").trim();c.includes("-webkit")||c.includes("-moz")||c.includes("-ms")||c.includes("-o")||c.includes("safe")?i+=";"+d+":"+c:e[d]&&!c.includes("import")&&e[d].includes("import")||(e[d]=c)}}if("img"==t.name||"picture"==t.name){s["data-src"]&&(s.src=s.src||s["data-src"],s["data-src"]=void 0),!s.src&&"picture"!=t.name||s.ignore||(this.bubble()?((s.src||"").includes(".webp")&&(t.webp=1),s.i=(this.imgNum++).toString()):s.ignore="T"),s.ignore&&(e["max-width"]="100%");var u=function(t){return e[t]&&!e[t].includes("auto")};if(u("width")){var f=this.STACK[this.STACK.length-1];e.width.includes("%")&&f&&(f.attrs.style||"").includes("display:inline")&&(f.attrs.style+=";max-width:100%",t.auto=1),parseInt(e.width)>screenWidth&&(e.height="auto"),u("height")&&(t.mode="scaleToFill")}else u("height")?t.mode="heightFix":t.auto=1}for(var d in e){var c=e[d];if((d.includes("flex")||"order"==d||"self-align"==d)&&(t.c=1),c.includes("url")){var g=c.indexOf("(");if(-1!=g++){for(;'"'==c[g]||"'"==c[g]||blankChar[c[g]];)g++;c=c.substr(0,g)+this.getUrl(c.substr(g,4))+c.substr(g+4)}}else c.includes("rpx")?c=c.replace(/[0-9.\s]*rpx/g,function(t){return parseFloat(t)*screenWidth/750+"px"}):"white-space"==d&&c.includes("pre")&&(this.pre=t.pre=!0);i+=";"+d+":"+c}i=i.substr(1),i&&(s.style=i),s.id&&(1&this.compress?s.id=void 0:this.useAnchor&&this.bubble()),2&this.compress&&s.class&&(s.class=void 0)}},{key:"popNode",value:function(t){if(t.pre){t.pre=this.pre=void 0;for(var s=this.STACK.length;s--;)this.STACK[s].pre&&(this.pre=!0)}if("head"==t.name||cfg.filter&&0==cfg.filter(t,this))return this.siblings().pop();if("picture"==t.name)return t.name="img",t.attrs.src||"img"!=(t.children[0]||"").name||(t.attrs.src=t.children[0].attrs.src),t.children=void 0;if(cfg.blockTags[t.name]?t.name="div":cfg.trustTags[t.name]||(t.name="span"),t.c)if("ul"==t.name){for(var i=1,e=this.STACK.length;e--;)"ul"==this.STACK[e].name&&i++;if(1!=i)for(var a=t.children.length;a--;)t.children[a].floor=i}else if("ol"==t.name)for(var r,h=0,n=1;r=t.children[h++];)"li"==r.name&&(r.type="ol",r.num=function(t,s){if("a"==s)return String.fromCharCode(97+(t-1)%26);if("A"==s)return String.fromCharCode(65+(t-1)%26);if("i"==s||"I"==s){t=(t-1)%99+1;var i=["I","II","III","IV","V","VI","VII","VIII","IX"],e=["X","XX","XXX","XL","L","LX","LXX","LXXX","XC"],a=(e[Math.floor(t/10)-1]||"")+(i[t%10-1]||"");return"i"==s?a.toLowerCase():a}return t}(n++,t.attrs.type)+".");if("table"==t.name&&(t.attrs.border&&(t.attrs.style="border:"+t.attrs.border+"px solid gray;"+(t.attrs.style||"")),t.attrs.cellspacing&&(t.attrs.style="border-spacing:"+t.attrs.cellspacing+"px;"+(t.attrs.style||"")),(t.attrs.border||t.attrs.cellpadding)&&function s(i){for(var e,a=0;e=i[a];a++)"th"==e.name||"td"==e.name?(t.attrs.border&&(e.attrs.style="border:"+t.attrs.border+"px solid gray;"+(e.attrs.style||"")),t.attrs.cellpadding&&(e.attrs.style="padding:"+t.attrs.cellpadding+"px;"+(e.attrs.style||""))):s(e.children||[])}(t.children)),this.CssHandler.pop&&this.CssHandler.pop(t),"div"==t.name&&!Object.keys(t.attrs).length){var l=this.siblings();(t.children||[]).length?1==t.children.length&&"div"==t.children[0].name&&(l[l.length-1]=t.children[0]):l.pop()}}},{key:"bubble",value:function(){for(var t=this.STACK.length;t--&&!cfg.richOnlyTags[this.STACK[t].name];)this.STACK[t].c=1;return-1==t}},{key:"getUrl",value:function(t){return this.domain&&("/"==t[0]?t="/"==t[1]?this.protocol+":"+t:this.domain+t:0!=t.indexOf("http")&&(t=this.domain+"/"+t)),t}},{key:"Text",value:function(t){if("<"==t){var s=this.data[this.i+1],i=function(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"};i(s)?(this.setText(),this.start=this.i+1,this.state=this.TagName):"/"==s?(this.setText(),i(this.data[++this.i+1])?(this.start=this.i+1,this.state=this.EndTag):this.Comment()):"!"==s&&(this.setText(),this.Comment())}}},{key:"Comment",value:function(){var t;t="--"==this.data.substring(this.i+2,this.i+4)?"--\x3e":"[CDATA["==this.data.substring(this.i+2,this.i+9)?"]]>":">",-1==(this.i=this.data.indexOf(t,this.i+2))?this.i=this.data.length:this.i+=t.length-1,this.start=this.i+1,this.state=this.Text}},{key:"TagName",value:function(t){if(blankChar[t]){for(this.tagName=this.section();blankChar[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)}else this.isClose()&&(this.tagName=this.section(),this.setNode())}},{key:"AttrName",value:function(t){var s=blankChar[t];if(s&&(this.attrName=this.section(),t=this.data[this.i]),"="==t){for(s||(this.attrName=this.section());blankChar[this.data[++this.i]];);this.start=this.i--,this.state=this.AttrValue}else s?this.setAttr():this.isClose()&&(this.attrName=this.section(),this.setAttr())}},{key:"AttrValue",value:function(t){if('"'==t||"'"==t){if(this.start++,-1==(this.i=this.data.indexOf(t,this.i+1)))return this.i=this.data.length;this.attrVal=this.section(),this.i++}else{for(;!blankChar[this.data[this.i]]&&!this.isClose();this.i++);this.attrVal=this.section()}for(;this.attrVal.includes("&quot;");)this.attrVal=this.attrVal.replace("&quot;",'"');this.setAttr()}},{key:"EndTag",value:function(t){if(blankChar[t]||">"==t||"/"==t){for(var s=this.section().toLowerCase(),i=this.STACK.length;i--&&this.STACK[i].name!=s;);if(-1!=i){for(var e;(e=this.STACK.pop()).name!=s;);this.popNode(e)}else"p"!=s&&"br"!=s||this.siblings().push({name:s,attrs:{}});this.i=this.data.indexOf(">",this.i),this.start=this.i+1,-1==this.i?this.i=this.data.length:this.state=this.Text}}}]),t}();module.exports=MpHtmlParser;