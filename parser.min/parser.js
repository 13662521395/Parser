// 小程序富文本插件 https://github.com/jin-yufeng/Parser
"use strict";function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function hash(t){for(var e=t.length,i=5381;e--;)i+=(i<<5)+t.charCodeAt(e);return i}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},cache={},config=require("./libs/config.js"),CssHandler=require("./libs/CssHandler.js"),document;try{document=require("./libs/document.js")}catch(t){}var fs=wx.getFileSystemManager?wx.getFileSystemManager():null,MpHtmlParser=require("./libs/MpHtmlParser.js");Component({properties:{html:{type:null,observer:function(t){if(this._refresh)return this._refresh=!1;this.setContent(t,!0)}},autosetTitle:{type:Boolean,value:!0},autopause:{type:Boolean,value:!0},domain:String,gestureZoom:Boolean,lazyLoad:Boolean,selectable:Boolean,tagStyle:Object,showWithAnimation:Boolean,useAnchor:Boolean,useCache:Boolean},relations:{"../parser-group/parser-group":{type:"ancestor"}},created:function(){this.imgList=[],this.imgList.setItem=function(t,e){var i=this;if(e){if(e.includes("http")&&this.includes(e)){for(var n,s="",a=0;(n=e[a])&&(s+=Math.random()>.5?n.toUpperCase():n,"/"!=n||"/"==e[a-1]||"/"==e[a+1]);a++);return s+=e.substring(a+1),this[t]=s}if(this[t]=e,e.includes("data:image")){var r=e.match(/data:image\/(\S+?);(\S+?),(.+)/);if(!r)return;var o=wx.env.USER_DATA_PATH+"/"+Date.now()+"."+r[1];fs&&fs.writeFile({filePath:o,data:r[3],encoding:r[2],success:function(e){return i[t]=o}})}}},this.imgList.each=function(t){for(var e=0;e<this.length;e++)this.setItem(e,t(this[e],e,this))}},detached:function(){this.imgList.each(function(t){t&&t.includes(wx.env.USER_DATA_PATH)&&fs&&fs.unlink({filePath:t})}),clearInterval(this.interval)},methods:{navigateTo:function(t){var e=this;if(!this.data.useAnchor)return t.fail&&t.fail({errMsg:"Anchor is disabled"});this.createSelectorQuery().select("._top"+(t.id?">>>#"+t.id:"")).boundingClientRect().selectViewport().scrollOffset().exec(function(i){if(!i[0])return e.group?e.group.navigateTo(e.i,t):t.fail&&t.fail({errMsg:"Label not found"});t.scrollTop=i[1].scrollTop+i[0].top,wx.pageScrollTo(t)})},getText:function(){for(var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data.html,i="",n=0;t=e[n++];)if("text"==t.type)i+=t.text.replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");else if("br"==t.type)i+="\n";else{var s="p"==t.name||"div"==t.name||"tr"==t.name||"li"==t.name||"h"==t.name[0]&&t.name[1]>"0"&&t.name[1]<"7";s&&i&&"\n"!=i[i.length-1]&&(i+="\n"),t.children&&(i+=this.getText(t.children)),s&&"\n"!=i[i.length-1]?i+="\n":"td"!=t.name&&"th"!=t.name||(i+="\t")}return i},getVideoContext:function(t){if(!t)return this.videoContexts;for(var e=this.videoContexts.length;e--;)if(this.videoContexts[e].id==t)return this.videoContexts[e];return null},setContent:function(t,e){var i=this,n={};if(t)if("string"==typeof t){var s=new MpHtmlParser(t,this.data);if(this.data.useCache){var a=hash(t);cache[a]?n.html=cache[a]:(n.html=s.parse(),cache[a]=n.html)}else n.html=s.parse();this.triggerEvent("parse",n.html)}else if(t.constructor==Array){if(t.length&&"Parser"!=t[0].PoweredBy){var s=new MpHtmlParser("",this.data);!function t(e){for(var i,n=0;i=e[n];n++)if("text"!=i.type){i.attrs=i.attrs||{};for(var a in i.attrs)config.trustAttrs[a]?"string"!=typeof i.attrs[a]&&(i.attrs[a]=i.attrs[a].toString()):i.attrs[a]=void 0;config.LabelHandler(i,s),config.ignoreTags[i.name]?e.splice(n--,1):i.children&&i.children.length?(s._STACK.push(i),t(i.children),s.popNode(s._STACK.pop())):i.children=void 0}}(t),n.html=t}e||(n.html=t)}else{if("object"!=(void 0===t?"undefined":_typeof(t))||!t.nodes)return console.warn("错误的 html 类型："+(void 0===t?"undefined":_typeof(t)));n.html=t.nodes,console.warn("错误的 html 类型：object 类型已废弃")}else{if(e)return;n.html=""}this.data.showWithAnimation&&(n.showAnimation="animation: show .5s"),((this._refresh=!!n.html)||n.showAnimation)&&this.setData(n),this.imgList.length=0,this.videoContexts=[],document&&(this.document=new document(n.html||t,"html",this));for(var r=this.selectAllComponents("._top,._top>>>._node"),o=r.length;o--;){var h,l,c,u;!function(){var t=r[o];for(t._top=i,h=!!t._observer,l=t.data.nodes.length;c=t.data.nodes[--l];)c.c||("img"==c.name?(c.attrs.i&&i.imgList.setItem(c.attrs.i,c.attrs.src),h||"0"==c.attrs.i||(h=!0,i.data.lazyLoad&&t.createIntersectionObserver?(wx.nextTick||setTimeout)(function(){t._observer=t.createIntersectionObserver(),t._observer.relativeToViewport({top:900,bottom:900}).observe("._img",function(){t.setData({imgLoad:!0}),t._observer&&(t._observer.disconnect(),t._observer=void 0)})},50):t.setData({imgLoad:!0}))):"video"==c.name?(u=wx.createVideoContext(c.attrs.id,t),u.id=c.attrs.id,i.videoContexts.unshift(u)):"audio"==c.name&&c.attrs.autoplay?wx.createAudioContext(c.attrs.id,t).play():"title"==c.name&&i.data.autosetTitle&&"text"==c.children[0].type&&wx.setNavigationBarTitle({title:c.children[0].text}))}()}(wx.nextTick||setTimeout)(function(){return i.triggerEvent("load")},50);var f;this.interval=setInterval(function(){i.createSelectorQuery().select("._top").boundingClientRect(function(t){i.width=t.width,t.height==f&&(i.triggerEvent("ready",t),clearInterval(i.interval)),f=t.height}).exec()},350)},preLoad:function(t,e){if("string"==typeof t){var i=hash(t);t=new MpHtmlParser(t,this.data).parse(),cache[i]=t}var n,s=[];!function t(e){for(var i,n=0;i=e[n++];)"img"==i.name&&i.attrs.src&&!s.includes(i.attrs.src)&&s.push(i.attrs.src),t(i.children||[])}(t),e&&(s=s.slice(0,e)),this.wait=(this.wait||[]).concat(s),this.data.imgs?this.data.imgs.length<15&&(n=this.data.imgs.concat(this.wait.splice(0,15-this.data.imgs.length))):n=this.wait.splice(0,15),n&&this.setData({imgs:n})},_load:function(t){this.wait.length&&this.setData(_defineProperty({},"imgs["+t.target.id+"]",this.wait.shift()))},_tap:function(t){if(this.data.gestureZoom&&t.timeStamp-this.lastTime<300){if(this.zoomIn)this.animation.translateX(0).scale(1).step(),wx.pageScrollTo({scrollTop:(t.detail.y-t.currentTarget.offsetTop+this.initY)/2-t.touches[0].clientY,duration:400});else{var e=t.detail.x-t.currentTarget.offsetLeft;this.initY=t.detail.y-t.currentTarget.offsetTop,this.animation=wx.createAnimation({transformOrigin:e+"px "+this.initY+"px 0",timingFunction:"ease-in-out"}),this.animation.scale(2).step(),this.tMax=e/2,this.tMin=(e-this.width)/2,this.tX=0}this.zoomIn=!this.zoomIn,this.setData({animation:this.animation.export()})}this.lastTime=t.timeStamp},_touchstart:function(t){1==t.touches.length&&(this.initX=this.lastX=t.touches[0].pageX)},_touchmove:function(t){var e=t.touches[0].pageX-this.lastX;if(this.zoomIn&&1==t.touches.length&&Math.abs(e)>20){if(this.lastX=t.touches[0].pageX,this.tX<=this.tMin&&e<0||this.tX>=this.tMax&&e>0)return;this.tX+=e*Math.abs(this.lastX-this.initX)*.05,this.tX<this.tMin&&(this.tX=this.tMin),this.tX>this.tMax&&(this.tX=this.tMax),this.animation.translateX(this.tX).step(),this.setData({animation:this.animation.export()})}}}});