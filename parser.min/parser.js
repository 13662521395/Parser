// 小程序富文本插件 https://github.com/jin-yufeng/Parser
"use strict";function hash(t){for(var e=t.length,i=5381;e--;)i+=(i<<5)+t.charCodeAt(e);return i}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},cache=getApp().parserCache={},config=require("./libs/config.js"),CssHandler=require("./libs/CssHandler.js"),document;try{document=require("./libs/document.js")}catch(t){}var fs=wx.getFileSystemManager?wx.getFileSystemManager():null,parseHtml=require("./libs/MpHtmlParser.js"),showAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(1).step().export();Component({properties:{html:{type:null,observer:function(t){if(this._refresh)return this._refresh=!1;this.setContent(t,!0)}},autosetTitle:{type:Boolean,value:!0},autopause:{type:Boolean,value:!0},domain:String,gestureZoom:Boolean,lazyLoad:Boolean,selectable:Boolean,tagStyle:Object,showWithAnimation:Boolean,useAnchor:Boolean,useCache:Boolean},relations:{"../parser-group/parser-group":{type:"ancestor"}},created:function(){this.imgList=[],this.imgList.setItem=function(t,e){var i=this;if(e.includes("base64")){this[t]=e;var s=e.match(/data:image\/(\S+?);base64,(\S+)/);if(!s)return;var a=wx.env.USER_DATA_PATH+"/"+Date.now()+"."+s[1];fs&&fs.writeFile({filePath:a,data:s[2],encoding:"base64",success:function(){return i[t]=a}})}else if(this.includes(e)){if("http"!=e.substring(0,4))return this[t]=e;for(var n="",o=0;o<e.length&&(n+=Math.random()>.5?e[o].toUpperCase():e[o],"/"!=e[o]||"/"==e[o-1]||"/"==e[o+1]);o++);n+=e.substring(o+1),this[t]=n}else this[t]=e},this.imgList.each=function(t){for(var e=0;e<this.length;e++){var i=t(this[e],e,this);i&&this.setItem(e,i)}},this._refresh=!1},detached:function(){this.imgList.each(function(t){t&&t.includes(wx.env.USER_DATA_PATH)&&fs&&fs.unlink({filePath:t})})},methods:{navigateTo:function(t){var e=this;if(t.fail=t.fail||function(){},!this.data.useAnchor)return t.fail({errMsg:"Use-anchor attribute is disabled"});this.createSelectorQuery().select("#root"+(t.id?">>>#"+t.id:"")).boundingClientRect().selectViewport().scrollOffset().exec(function(i){if(!i[0])return e.group?e.group.navigateTo(e.i,t):t.fail({errMsg:"Label not found"});wx.pageScrollTo({scrollTop:i[1].scrollTop+i[0].top,success:t.success,fail:t.fail})})},getText:function(){function t(i){if(i)for(var s,a=0;s=i[a++];)if("text"==s.type)e+=s.text;else if("br"==s.type)e+="\n";else{var n="p"==s.name||"div"==s.name||"tr"==s.name||"li"==s.name||"h"==s.name[0]&&s.name[1]>"0"&&s.name[1]<"7";n&&e&&"\n"!=e[e.length-1]&&(e+="\n"),t(s.children),n&&"\n"!=e[e.length-1]?e+="\n":"td"!=s.name&&"th"!=s.name||(e+="\t")}}var e="";return t(this.data.html),e.replace(/&nbsp;/g," ")},getVideoContext:function(t){if(!t)return this.videoContexts;for(var e=this.videoContexts.length;e--;)if(this.videoContexts[e].id==t)return this.videoContexts[e];return null},setContent:function(t,e){var i=this,s={controls:{}};if(this.data.showWithAnimation&&(s.showAnimation=showAnimation),t)if("string"==typeof t){if(this.data.useCache){var a=hash(t);cache[a]?s.html=cache[a]:(s.html=parseHtml(t,this.data),cache[a]=s.html)}else s.html=parseHtml(t,this.data);this.triggerEvent("parse",s.html)}else if(t.constructor==Array){if(t.length&&"Parser"!=t[0].PoweredBy){var n={_imgNum:0,_videoNum:0,_audioNum:0,_domain:this.data.domain,_protocol:this.data.domain&&this.data.domain.includes("://")?this.data.domain.split("://")[0]:"http",_STACK:[],CssHandler:new CssHandler(this.data.tagStyle)};!function t(e){for(var i,s=0;i=e[s++];)if("text"!=i.type){i.attrs=i.attrs||{};for(var a in i.attrs)config.trustAttrs[a]?"string"!=typeof i.attrs[a]&&(i.attrs[a]=i.attrs[a].toString()):i.attrs[a]=void 0;config.LabelHandler(i,n),config.blockTags[i.name]?i.name="div":config.trustTags[i.name]||(i.name="span"),i.children&&i.children.length?(n._STACK.push(i),t(i.children),n._STACK.pop()):i.children=void 0}}(t),s.html=t}e||(s.html=t)}else{if("object"!=(void 0===t?"undefined":_typeof(t))||!t.nodes)return console.warn("错误的 html 类型："+(void 0===t?"undefined":_typeof(t)));s.html=t.nodes,console.warn("错误的 html 类型：object 类型已废弃，请直接将 html 设置为 object.nodes")}else{if(e)return;s.html=""}this._refresh=!!s.html,this.setData(s),this.imgList.length=0,this.videoContexts=[],document&&(this.document=new document("html",s.html||t,this));for(var o=this.selectAllComponents("#root,#root>>>._node"),r=o.length;r--;){var h,l,c,u;!function(){var t=o[r];for(t._top=i,h=!!t._observer,l=t.data.nodes.length;c=t.data.nodes[--l];)c.c||("img"==c.name?(c.attrs.src&&c.attrs.i&&i.imgList.setItem(c.attrs.i,c.attrs.src),h||(h=!0,i.data.lazyLoad&&t.createIntersectionObserver?(wx.nextTick||setTimeout)(function(){t._observer=t.createIntersectionObserver(),t._observer.relativeToViewport({top:1e3,bottom:1e3}).observe("._img",function(){t.setData({imgLoad:!0}),t._observer.disconnect(),t._observer=void 0})},50):t.setData({imgLoad:!0}))):"video"==c.name?(u=wx.createVideoContext(c.attrs.id,t),u.id=c.attrs.id,i.videoContexts.push(u)):"audio"==c.name&&c.attrs.autoplay?wx.createAudioContext(c.attrs.id,t).play():"title"==c.name&&i.data.autosetTitle&&"text"==c.children[0].type&&c.children[0].text&&wx.setNavigationBarTitle({title:c.children[0].text}))}()}(wx.nextTick||setTimeout)(function(){i.createSelectorQuery().select("#root").boundingClientRect(function(t){i.width=t.width,i.triggerEvent("ready",t)}).exec()},50)},_tap:function(t){if(this.data.gestureZoom&&t.timeStamp-this.lastTime<300){if(this.zoomIn)this.animation.translateX(0).scale(1).step(),wx.pageScrollTo({scrollTop:(t.detail.y-t.currentTarget.offsetTop+this.initY)/2-t.touches[0].clientY,duration:400});else{var e=t.detail.x-t.currentTarget.offsetLeft;this.initY=t.detail.y-t.currentTarget.offsetTop,this.animation=wx.createAnimation({transformOrigin:e+"px "+this.initY+"px 0",timingFunction:"ease-in-out"}),this.animation.scale(2).step(),this.translateMax=e/2,this.translateMin=(e-this.width)/2,this.translateX=0}this.zoomIn=!this.zoomIn,this.setData({showAnimation:this.animation.export()})}this.lastTime=t.timeStamp},_touchstart:function(t){1==t.touches.length&&(this.initX=this.lastX=t.touches[0].pageX)},_touchmove:function(t){var e=t.touches[0].pageX-this.lastX;if(this.zoomIn&&1==t.touches.length&&Math.abs(e)>20){if(this.lastX=t.touches[0].pageX,this.translateX<=this.translateMin&&e<0||this.translateX>=this.translateMax&&e>0)return;this.translateX+=e*Math.abs(this.lastX-this.initX)*.05,this.translateX<this.translateMin&&(this.translateX=this.translateMin),this.translateX>this.translateMax&&(this.translateX=this.translateMax),this.animation.translateX(this.translateX).step(),this.setData({showAnimation:this.animation.export()})}}}});