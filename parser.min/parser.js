// 小程序富文本插件 https://github.com/jin-yufeng/Parser
"use strict";function Hash(t){for(var e=t.length,a=5381;e--;)a+=(a<<5)+t.charCodeAt(e);return a}function Deduplicate(t){if(0!=t.indexOf("http"))return t;for(var e="",a=0;a<t.length&&(e+=Math.random()>=.5?t[a].toUpperCase():t[a].toLowerCase(),"/"!=t[a]||"/"==t[a-1]||"/"==t[a+1]);a++);return e+=t.substring(a+1)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},parseHtml=require("./libs/MpHtmlParser.js"),cache=getApp().parserCache={},CssHandler=require("./libs/CssHandler.js"),config=require("./libs/config.js"),document;try{document=require("./libs/document.js")}catch(t){}var hideAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(0).step().export(),showAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(1).step().export();Component({properties:{html:{type:null,value:null,observer:function(t){if(this._refresh)return this._refresh=!1;this.setContent(t,void 0,!0)}},autopause:{type:Boolean,value:!0},autosetTitle:{type:Boolean,value:!0},domain:{type:String,value:null},gestureZoom:{type:Boolean,value:!1},lazyLoad:{type:Boolean,value:!1},selectable:{type:Boolean,value:!1},tagStyle:{type:Object,value:{}},showWithAnimation:{type:Boolean,value:!1},useAnchor:{type:Boolean,value:!1},useCache:{type:Boolean,value:!1}},created:function(){var t=this;this.navigateTo=function(e){if(e.fail=e.fail||function(){},!t.data.useAnchor)return e.fail({errMsg:"Use-anchor attribute is disabled"});var a=t.createSelectorQuery();a.select("#contain"+(e.id?">>>#"+e.id:"")).boundingClientRect(),a.selectViewport().scrollOffset(),a.exec(function(t){if(!t||!t[0])return e.fail({errMsg:"Label not found"});wx.pageScrollTo({scrollTop:t[1].scrollTop+t[0].top,success:e.success,fail:e.fail})})},this.getText=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],a="";if(!t.data.html||!t.data.html.length)return"";for(var i=0;i<t.data.html.length;i++)!function t(i){if("text"==i.type)return a+=i.text;if(e&&(("p"==i.name||"div"==i.name||"tr"==i.name||"li"==i.name||/h[1-6]/.test(i.name))&&a&&"\n"!=a[a.length-1]||"br"==i.name)&&(a+="\n"),i.children)for(var n=0;n<i.children.length;n++)t(i.children[n]);e&&("p"==i.name||"div"==i.name||"tr"==i.name||"li"==i.name||/h[1-6]/.test(i.name))&&a&&"\n"!=a[a.length-1]?a+="\n":e&&"td"==i.name&&(a+="\t")}(t.data.html[i]);return a},this.getVideoContext=function(e){if(!e)return t.videoContexts;for(var a=t.videoContexts.length;a--;)if(t.videoContexts[a].id==e)return t.videoContexts[a];return null},this.imgList=[],this.imgList.each=function(t){for(var e=0;e<this.length;e++){var a=t(this[e],e,this);a&&(this.includes(a)?this[e]=Deduplicate(a):this[e]=a)}},this._refresh=!1,this.setContent=function(e,a,i){if("object"==(void 0===a?"undefined":_typeof(a)))for(var n in a)n=n.replace(/-(\w)/g,function(t,e){return e.toUpperCase()}),t.data[n]=a[n];var o={controls:{}};if(t.data.showWithAnimation&&(o.showAnimation=showAnimation,o.hideAnimation=hideAnimation),e)if("string"==typeof e){if(t.data.useCache){var s=Hash(e);cache[s]?o.html=cache[s]:(o.html=parseHtml(e,t.data),cache[s]=o.html)}else o.html=parseHtml(e,t.data);t.triggerEvent("parse",o.html)}else if(e.constructor==Array){if(e.length&&"Parser"!=e[0].PoweredBy){var r={_imgNum:0,_videoNum:0,_audioNum:0,_domain:t.data.domain,_protocol:t.data.domain?t.data.domain.includes("://")?t.data.domain.split("://")[0]:"http":void 0,_STACK:[],CssHandler:new CssHandler(t.data.tagStyle)};r.CssHandler.getStyle(""),function t(e){for(var a,i=0;a=e[i++];)if("text"!=a.type){a.attrs=a.attrs||{};for(var n in a.attrs)config.trustAttrs[n]?"string"!=typeof a.attrs[n]&&(a.attrs[n]=a.attrs[n].toString()):a.attrs[n]=void 0;config.LabelAttrsHandler(a,r),config.blockTags[a.name]?a.name="div":config.trustTags[a.name]||(a.name="span"),a.children&&a.children.length?(r._STACK.push(a),t(a.children),r._STACK.pop()):a.children=void 0}}(e),o.html=e}i||(o.html=e)}else{if("object"!=(void 0===e?"undefined":_typeof(e))||!e.nodes)return t.triggerEvent("error",{source:"parse",errMsg:"错误的html类型："+(void 0===e?"undefined":_typeof(e))});o.html=e.nodes,console.warn("Parser 类型错误：object 类型已废弃，请直接将 html 设置为 object.nodes （array 类型）")}else{if(i)return;o.html=""}t._refresh=!!o.html,t.setData(o),t.imgList.length=0,t.videoContexts=[],document&&(t.document=new document("html",o.html||e,t));for(var l=[t.selectComponent("#contain")].concat(t.selectAllComponents("#contain>>>._node")),h=l.length;h--;){var c,u,d,u,d,m;!function(){var e=l[h];for(e._top=t,c=!!e._observer,u=e.data.nodes.length,u=e.data.nodes.length;d=e.data.nodes[--u];)d.continue||("img"==d.name?(d.attrs.src&&d.attrs.i&&(-1==t.imgList.indexOf(d.attrs.src)?t.imgList[d.attrs.i]=d.attrs.src:t.imgList[d.attrs.i]=Deduplicate(d.attrs.src)),c||(c=!0,(wx.nextTick||setTimeout)(function(){t.data.lazyLoad&&e.createIntersectionObserver?(e._observer=e.createIntersectionObserver(),e._observer.relativeToViewport({top:1e3,bottom:1e3}).observe("._img",function(){e.setData({imgLoad:!0}),e._observer.disconnect(),e._observer=void 0})):e.setData({imgLoad:!0})},50))):"video"==d.name?(m=wx.createVideoContext(d.attrs.id,e),m.id=d.attrs.id,t.videoContexts.push(m)):"audio"==d.name&&d.attrs.autoplay?wx.createAudioContext(d.attrs.id,e).play():"title"==d.name&&t.data.autosetTitle&&"text"==d.children[0].type&&d.children[0].text&&wx.setNavigationBarTitle({title:d.children[0].text}))}()}(wx.nextTick||setTimeout)(function(){t.createSelectorQuery().select("#contain").boundingClientRect(function(e){t.width=e.width,t.triggerEvent("ready",e)}).exec()},50)}},methods:{tap:function(t){if(this.data.gestureZoom&&t.timeStamp-this.lastTime<300){if(this.zoomIn)this.animation.translateX(0).scale(1).step(),wx.pageScrollTo({scrollTop:(t.detail.y-t.currentTarget.offsetTop+this.initY)/2-t.touches[0].clientY,duration:400});else{var e=t.detail.x-t.currentTarget.offsetLeft;this.initY=t.detail.y-t.currentTarget.offsetTop,this.animation=wx.createAnimation({transformOrigin:e+"px "+this.initY+"px 0",timingFunction:"ease-in-out"}),this.animation.scale(2).step(),this.translateMax=e/2,this.translateMin=(e-this.width)/2,this.translateX=0}this.zoomIn=!this.zoomIn,this.setData({showAnimation:this.animation.export()})}this.lastTime=t.timeStamp},touchstart:function(t){1==t.touches.length&&(this.initX=this.lastX=t.touches[0].pageX)},touchmove:function(t){var e=t.touches[0].pageX-this.lastX;if(this.zoomIn&&1==t.touches.length&&Math.abs(e)>20){if(this.lastX=t.touches[0].pageX,this.translateX<=this.translateMin&&e<0||this.translateX>=this.translateMax&&e>0)return;this.translateX+=e*Math.abs(this.lastX-this.initX)*.05,this.translateX<this.translateMin&&(this.translateX=this.translateMin),this.translateX>this.translateMax&&(this.translateX=this.translateMax),this.animation.translateX(this.translateX).step(),this.setData({showAnimation:this.animation.export()})}}}});