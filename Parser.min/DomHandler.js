"use strict";function DomHandler(t,e){this.imgList=[],this.imgIndex=0,this.nodes=[],this.title="",this._videoNum=0,this._audioNum=0,this._CssHandler=new CssHandler(t,e.tagStyle),this._tagStack=[],this._whiteSpace=!1,this._domain=e.domain,this._protocol=/:\/\//.test(e.domain)?e.domain.split(/:\/\//)[0]:"http",this._useAnchor=e.useAnchor}var emoji;try{emoji=require("./emoji.js")}catch(t){}var CssHandler=require("./CssHandler.js"),CanIUse=require("./api.js").versionHigherThan("2.7.1"),trustTag={a:0,abbr:1,ad:0,audio:0,b:1,blockquote:1,br:0,code:1,col:0,colgroup:0,dd:1,del:1,dl:1,dt:1,div:1,em:1,fieldset:0,font:1,h1:0,h2:0,h3:0,h4:0,h5:0,h6:0,hr:0,i:1,img:1,ins:1,label:1,legend:0,li:0,ol:0,p:1,q:1,source:0,span:1,strong:1,sub:0,sup:0,table:0,tbody:0,td:0,tfoot:0,th:0,thead:0,tr:0,u:1,ul:0,video:1},blockTag={address:!0,article:!0,aside:!0,body:!0,center:!0,cite:!0,footer:!0,header:!0,html:!0,nav:!0,pre:!0,section:!0},ignoreTag={area:!0,base:!0,basefont:!0,canvas:!0,circle:!0,command:!0,ellipse:!0,embed:!0,frame:!0,head:!0,iframe:!0,input:!0,isindex:!0,keygen:!0,line:!0,link:!0,map:!0,meta:!0,param:!0,path:!0,polygon:!0,polyline:!0,rect:!0,script:!0,stop:!0,textarea:!0,title:!0,track:!0,use:!0,wbr:!0};CanIUse?(trustTag.bdi=0,trustTag.bdo=0,trustTag.caption=0,trustTag.rt=0,trustTag.ruby=0,ignoreTag.rp=!0,trustTag.big=1,trustTag.small=1,trustTag.pre=0,delete blockTag.pre):blockTag.caption=!0,DomHandler.prototype._addDomElement=function(t){("pre"==t.name||t.attrs&&/white-space\s*:\s*pre/.test(t.attrs.style))&&(this._whiteSpace=!0,t.pre=!0);var e=this._tagStack[this._tagStack.length-1];(e?e.children:this.nodes).push(t)},DomHandler.prototype._bubbling=function(){for(var t=this._tagStack.length-1;t>=0;t--){if(!trustTag[this._tagStack[t].name])return this._tagStack[t].name;this._tagStack[t].continue=!0}},DomHandler.prototype.onopentag=function(t,e){var s={children:[]},a=this._CssHandler.match(t,e,s);switch(t){case"div":case"p":e.align&&(e.style+=";text-align:"+e.align,delete e.align);break;case"img":e.width&&(e.style="width:"+e.width+(/[0-9]/.test(e.width[e.width.length-1])?"px":"")+";"+e.style,delete e.width),e["data-src"]&&(e.src=e.src||e["data-src"],delete e["data-src"]),!e.hasOwnProperty("ignore")&&e.src&&(-1==this.imgList.indexOf(e.src)||/base64/.test(e.src)||(e.src=e.src+(/\?/.test(e.src)?"&":"?")+"parserid="+this.imgIndex++),this.imgList.push(e.src),"a"==this._bubbling()&&(e.ignore="")),this._domain&&"/"==e.src[0]&&("/"==e.src[1]?e.src=this._protocol+":"+e.src:e.src=this._domain+e.src);break;case"font":if(t="span",e.color&&(e.style+=";color:"+e.color,delete e.color),e.face&&(e.style+=";font-family:"+e.face,delete e.face),e.size){var r=parseInt(e.size);r<1?r=1:r>7&&(r=7);var i=[10,13,16,18,24,32,48];e.style+=";font-size:"+i[r-1]+"px",delete e.size}break;case"a":case"ad":this._bubbling();break;case"video":case"audio":e.loop=e.hasOwnProperty("loop"),e.controls=e.hasOwnProperty("controls"),e.autoplay=e.hasOwnProperty("autoplay"),"video"==t&&(e.muted=e.hasOwnProperty("muted"),e.width&&(e.style="width:"+parseFloat(e.width)+"px;"+e.style,delete e.width),e.height&&(e.style="height:"+parseFloat(e.height)+"px;"+e.style,delete e.height)),e.id=t+ ++this["_"+t+"Num"],e.source=[],e.src&&e.source.push(e.src),e.controls||e.autoplay||console.warn("存在没有controls属性的"+t+"标签，可能导致无法播放",e),this._bubbling();break;case"source":var o=this._tagStack[this._tagStack.length-1];return!o||"video"!=o.name&&"audio"!=o.name||(o.attrs.source.push(e.src),o.attrs.src||(o.attrs.src=e.src)),void this._tagStack.push(s)}this._useAnchor&&e.id&&this._bubbling(),e.style=a+e.style,blockTag[t]?t="div":trustTag.hasOwnProperty(t)||(t="span"),s.name=t,s.attrs=e,this._addDomElement(s),this._tagStack.push(s)},DomHandler.prototype.ontext=function(t){if(!this._whiteSpace){if(!/\S/.test(t))return;t=t.replace(/\s+/g," ")}emoji&&(t=emoji.parseEmoji(t));var e={text:t.replace(/&nbsp;/g," "),type:"text"};/&#*((?!sp|lt|gt).){2,5};/.test(t)&&(e.decode=!0),this._addDomElement(e)},DomHandler.prototype.onclosetag=function(t){var e=this._tagStack.pop(),s=this._tagStack.length?this._tagStack[this._tagStack.length-1].children:this.nodes;if(ignoreTag[t]){if("title"==t)try{this.title=e.children[0].text}catch(t){}s.pop()}if("table"==e.name){if(e.attrs.border&&(e.attrs.style+=";border:"+e.attrs.border+"px solid gray;"),e.attrs.hasOwnProperty("cellspacing")&&(e.attrs.style+=";border-spacing:"+e.attrs.cellspacing+"px"),e.attrs.border||e.attrs.hasOwnProperty("cellpadding")){var a=!0,r=!1,i=void 0;try{for(var o,l=e.children[Symbol.iterator]();!(a=(o=l.next()).done);a=!0){var n=o.value;!function t(s){if("text"!=s.type){"th"!=s.name&&"td"!=s.name||(e.attrs.border&&(s.attrs.style+=";border:"+e.attrs.border+"px solid gray;"),e.attrs.hasOwnProperty("cellpadding")&&(s.attrs.style+=";padding:"+e.attrs.cellpadding+"px"));var a=!0,r=!1,i=void 0;try{for(var o,l=s.children[Symbol.iterator]();!(a=(o=l.next()).done);a=!0){t(o.value)}}catch(t){r=!0,i=t}finally{try{!a&&l.return&&l.return()}finally{if(r)throw i}}}}(n)}}catch(t){r=!0,i=t}finally{try{!a&&l.return&&l.return()}finally{if(r)throw i}}}}if(1==e.children.length&&"div"==e.name){var d=e.children[0];"div"!=d.name||/padding/.test(e.attrs.style)||/margin/.test(e.attrs.style)&&/margin/.test(d.attrs.style)||/display/.test(e.attrs.style)||/display/.test(d.attrs.style)||e.attrs.id&&d.attrs.id||e.attrs.class&&d.attrs.class||(/padding/.test(d.attrs.style)&&(d.attrs.style=";box-sizing:border-box;"+d.attrs.style),d.attrs.style=e.attrs.style+";"+d.attrs.style,d.attrs.id=(d.attrs.id||"")+(e.attrs.id||""),d.attrs.class=(d.attrs.class||"")+(e.attrs.class||""),s[s.indexOf(e)]=d)}if(e.pre){this._whiteSpace=!1;var c=!0,h=!1,p=void 0;try{for(var g,u=this._tagStack[Symbol.iterator]();!(c=(g=u.next()).done);c=!0){g.value.pre&&(this._whiteSpace=!0)}}catch(t){h=!0,p=t}finally{try{!c&&u.return&&u.return()}finally{if(h)throw p}}delete e.pre}this._CssHandler.pop&&this._CssHandler.pop(e)},module.exports=DomHandler;