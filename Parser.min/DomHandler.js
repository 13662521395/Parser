"use strict";function initStyle(t){return t.a="display:inline;color:#366092;word-break:break-all;"+(t.a||""),t.address="font-style:italic;"+(t.address||""),t.blockquote=t.blockquote||"background-color:#f6f6f6;border-left:3px solid #dbdbdb;color:#6c6c6c;padding:5px 0 5px 10px",t.center="text-align:center;"+(t.center||""),t.cite="font-style:italic;"+(t.cite||""),t.code=t.code||"padding:0 1px 0 1px;margin-left:2px;margin-right:2px;background-color:#f8f8f8;border:1px solid #cccccc;border-radius:3px",t.dd="margin-left:40px;"+(t.dd||""),t.img="max-width:100%;"+(t.img||""),t.mark="display:inline;background-color:yellow;"+(t.mark||""),t.pre="overflow:scroll;"+(t.pre||"background-color:#f6f8fa;padding:5px;border-radius:5px;"),t.s="display:inline;text-decoration:line-through;"+(t.s||""),t.u="display:inline;text-decoration:underline;"+(t.u||""),CanIUse||(blockTag.caption=!0,t.big="display:inline;font-size:1.2em;"+(t.big||""),t.small="display:inline;font-size:0.8em;"+(t.small||""),t.pre="font-family:monospace;white-space:pre;"+t.pre),t}function DomHandler(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.imgList=[],this.imgIndex=0,this.nodes=[],this.title="",this._videoNum=0,this._audioNum=0,this._style=new CssTokenizer(t,initStyle(e)).parse(),this._tagStack=[],this._whiteSpace=!1}var CssTokenizer=require("./CssTokenizer.js"),CanIUse=require("./api.js").versionHigherThan("2.7.1"),Common=1,Rich=2,trustTag={a:Rich,abbr:Common,audio:Rich,b:Common,blockquote:Common,br:Rich,code:Common,col:Rich,colgroup:Rich,dd:Common,del:Common,dl:Common,dt:Common,div:Common,em:Common,fieldset:Rich,font:Common,h1:Rich,h2:Rich,h3:Rich,h4:Rich,h5:Rich,h6:Rich,hr:Rich,i:Common,img:Common,ins:Common,label:Common,legend:Rich,li:Rich,ol:Rich,p:Common,q:Common,source:Rich,span:Common,strong:Common,sub:Rich,sup:Rich,table:Rich,tbody:Rich,td:Rich,tfoot:Rich,th:Rich,thead:Rich,tr:Rich,u:Common,ul:Rich,video:Common},blockTag={address:!0,article:!0,aside:!0,body:!0,center:!0,cite:!0,footer:!0,header:!0,html:!0,nav:!0,pre:!0,section:!0},textTag={a:!0,abbr:!0,b:!0,big:!0,code:!0,del:!0,em:!0,font:!0,i:!0,ins:!0,label:!0,mark:!0,q:!0,s:!0,small:!0,span:!0,strong:!0,u:!0},ignoreTag={area:!0,base:!0,basefont:!0,canvas:!0,circle:!0,command:!0,ellipse:!0,embed:!0,frame:!0,head:!0,iframe:!0,input:!0,isindex:!0,keygen:!0,line:!0,link:!0,map:!0,meta:!0,param:!0,path:!0,polygon:!0,polyline:!0,rect:!0,script:!0,stop:!0,textarea:!0,title:!0,track:!0,use:!0,wbr:!0};CanIUse&&(trustTag.bdi=Rich,trustTag.bdo=Rich,trustTag.caption=Rich,trustTag.rt=Rich,trustTag.ruby=Rich,ignoreTag.rp=!0,trustTag.big=Common,trustTag.small=Common,trustTag.pre=Rich,delete blockTag.pre),DomHandler.prototype._addDomElement=function(t){("pre"==t.name||t.attrs&&/white-space\s*:\s*pre/.test(t.attrs.style))&&(this._whiteSpace=!0,t.pre=!0);var e=this._tagStack[this._tagStack.length-1];(e?e.children:this.nodes).push(t)},DomHandler.prototype._bubbling=function(){for(var t=this._tagStack.length-1;t>=0;t--){if(trustTag[this._tagStack[t].name]!=Common)return this._tagStack[t].name;if(this._tagStack[t].continue=!0,t==this._tagStack.length-1){var e=!0,i=!1,a=void 0;try{for(var s,r=this._tagStack[t].children[Symbol.iterator]();!(e=(s=r.next()).done);e=!0){var o=s.value;textTag[o.name]&&(o.continue=!0)}}catch(t){i=!0,a=t}finally{try{!e&&r.return&&r.return()}finally{if(i)throw a}}}}},DomHandler.prototype.onopentag=function(t,e){var i={children:[]},a=this._style[t]?this._style[t]+";":"";if(e.id&&(a+=this._style["#"+e.id]?this._style["#"+e.id]+";":"",delete e.id),e.class){var s=!0,r=!1,o=void 0;try{for(var n,l=e.class.split(" ")[Symbol.iterator]();!(s=(n=l.next()).done);s=!0){var c=n.value;a+=this._style["."+c]?this._style["."+c]+";":""}}catch(t){r=!0,o=t}finally{try{!s&&l.return&&l.return()}finally{if(r)throw o}}delete e.class}switch(t){case"div":case"p":e.align&&(e.style+=";text-align:"+e.align,delete e.align);break;case"img":e.width&&(e.style="width:"+e.width+(/[0-9]/.test(e.width[e.width.length-1])?"px":"")+";"+e.style,delete e.width),e["data-src"]&&(e.src=e.src||e["data-src"],delete e["data-src"]),!e.hasOwnProperty("ignore")&&e.src&&(-1!=this.imgList.indexOf(e.src)&&(e.src=e.src+"?index="+this.imgIndex++),this.imgList.push(e.src),"a"==this._bubbling()&&(e.ignore=""));break;case"font":if(t="span",e.color&&(e.style+=";color:"+e.color,delete e.color),e.face&&(e.style+=";font-family:"+e.face,delete e.face),e.size){var h=parseInt(e.size);h<1?h=1:h>7&&(h=7);var d=[10,13,16,18,24,32,48];e.style+=";font-size:"+d[h-1]+"px",delete e.size}break;case"a":this._bubbling();break;case"video":case"audio":e.loop=e.hasOwnProperty("loop"),e.controls=e.hasOwnProperty("controls"),e.autoplay=e.hasOwnProperty("autoplay"),"video"==t&&(e.muted=e.hasOwnProperty("muted"),e.width&&(e.style="width:"+parseFloat(e.width)+"px;"+e.style,delete e.width),e.height&&(e.style="height:"+parseFloat(e.height)+"px;"+e.style,delete e.height)),e.id=t+ ++this["_"+t+"Num"],e.source=[],e.src&&e.source.push(e.src),e.controls||e.autoplay||console.warn("存在没有controls属性的"+t+"标签，可能导致无法播放",e),this._bubbling();break;case"source":var m=this._tagStack[this._tagStack.length-1];return!m||"video"!=m.name&&"audio"!=m.name||(m.attrs.source.push(e.src),m.attrs.src||(m.attrs.src=e.src)),void this._tagStack.push(i)}e.style=a+e.style,textTag[t]?this._tagStack.length&&!this._tagStack[this._tagStack.length-1].continue||(i.continue=!0):blockTag[t]?t="div":trustTag[t]||(t="span"),i.name=t,i.attrs=e,this._addDomElement(i),this._tagStack.push(i)},DomHandler.prototype.ontext=function(t){if(this._whiteSpace||(t=t.replace(/\s+/g," ")),t){var e={text:t.replace(/&nbsp;/g," "),type:"text"};/&#*((?!sp|lt|gt).){2,5};/.test(t)&&(e.decode=!0),this._addDomElement(e)}},DomHandler.prototype.onclosetag=function(t){var e=this._tagStack.pop();if(ignoreTag[t]){if("title"==t)try{this.title=e.children[0].text}catch(t){}var i=this._tagStack[this._tagStack.length-1];(i?i.children:this.nodes).pop()}if(!(1!=e.children.length||"div"!=e.name||"div"!=e.children[0].name||/padding/.test(e.attrs.style)||/margin/.test(e.attrs.style)&&/margin/.test(e.children[0].attrs.style)||/display/.test(e.attrs.style)||/display/.test(e.children[0].attrs.style))){var a=this._tagStack.length?this._tagStack[this._tagStack.length-1].children:this.nodes,s=a.indexOf(e);/padding/.test(e.children[0].attrs.style)&&(e.children[0].attrs.style=";box-sizing:border-box;"+e.children[0].attrs.style),e.children[0].attrs.style=e.attrs.style+";"+e.children[0].attrs.style,a[s]=e.children[0]}if(e.pre){this._whiteSpace=!1;var r=!0,o=!1,n=void 0;try{for(var l,c=this._tagStack[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){l.value.pre&&(this._whiteSpace=!0)}}catch(t){o=!0,n=t}finally{try{!r&&c.return&&c.return()}finally{if(o)throw n}}}},module.exports=DomHandler;