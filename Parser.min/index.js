/* Parser 小程序富文本插件 https://github.com/jin-yufeng/Parser */
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Document;try{Document=require("./libs/document.js")}catch(t){}var parseHtmlSync=require("./libs/MpHtmlParser.js").parseHtmlSync,App=getApp();Component({created:function(){var t=this;this.navigateTo=function(e){e.success=e.success||function(){return null},e.fail=e.fail||function(){return null};var a=function(a){var o=t.createSelectorQuery();o.select(a).boundingClientRect(),o.selectViewport().scrollOffset(),o.exec(function(t){if(!t||!t[0])return e.fail({errMsg:"Label Not Found"});wx.pageScrollTo({scrollTop:t[1].scrollTop+t[0].top,success:e.success,fail:e.fail})})};a(e.id?"#contain >>> #"+e.id:"#contain")},this.getText=function(){var e="";if(!t.data.html)return"";var a=!0,o=!1,n=void 0;try{for(var r,i=(t.data.html.nodes||(t.data.html[0].name||t.data.html[0].type?t.data.html:t.data.nodes))[Symbol.iterator]();!(a=(r=i.next()).done);a=!0){var l=r.value;!function t(a){if("text"==a.type)return e+=a.text;"p"!=a.name&&"div"!=a.name&&"br"!=a.name||"\n"==e[e.length-1]||(e+="\n");var o=!0,n=!1,r=void 0;try{for(var i,l=a.children[Symbol.iterator]();!(o=(i=l.next()).done);o=!0){t(i.value)}}catch(t){n=!0,r=t}finally{try{!o&&l.return&&l.return()}finally{if(n)throw r}}}(l)}}catch(t){o=!0,n=t}finally{try{!a&&i.return&&i.return()}finally{if(o)throw n}}return e},this.getVideoContext=function(e){if(!e)return t.videoContexts;var a=!0,o=!1,n=void 0;try{for(var r,i=t.videoContexts[Symbol.iterator]();!(a=(r=i.next()).done);a=!0){var l=r.value;if(l.id==e)return l}}catch(t){o=!0,n=t}finally{try{!a&&i.return&&i.return()}finally{if(o)throw n}}return null},this._ready=function(e,a){e&&t.data.autosetTitle&&wx.setNavigationBarTitle({title:e}),t.imgList=a||[],t.videoContexts=[];var o=[t.selectComponent("#contain")];o=o.concat(t.selectAllComponents("#contain>>>.node"));var n=!0,r=!1,i=void 0;try{for(var l,s=o[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var u=l.value;u._top=t;var c=!0,d=!1,y=void 0;try{for(var v,m=u.data.nodes[Symbol.iterator]();!(c=(v=m.next()).done);c=!0){var f=v.value;if("video"==f.name){var h=wx.createVideoContext(f.attrs.id,u);h.id=f.attrs.id,t.videoContexts.push(h)}else"audio"==f.name&&f.attrs.autoplay&&wx.createAudioContext(f.attrs.id,u).play()}}catch(t){d=!0,y=t}finally{try{!c&&m.return&&m.return()}finally{if(d)throw y}}}}catch(t){r=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}(wx.nextTick||setTimeout)(function(){var e=!0,a=!1,n=void 0;try{for(var r,i=o[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){var l,s;!function(){var e=r.value;l=!1;var a=!0,o=!1,n=void 0;try{for(var i,u=e.data.nodes[Symbol.iterator]();!(a=(i=u.next()).done);a=!0)s=i.value,"img"!=s.name||l||(l=!0,t.data.lazyLoad&&e.createIntersectionObserver?(e._observer=e.createIntersectionObserver(),e._observer.relativeToViewport({top:1e3,bottom:1e3}).observe(".img",function(t){e.setData({imgLoad:!0}),e._observer.disconnect(),e._observer=null})):e.setData({imgLoad:!0}))}catch(t){o=!0,n=t}finally{try{!a&&u.return&&u.return()}finally{if(o)throw n}}}()}}catch(t){a=!0,n=t}finally{try{!e&&i.return&&i.return()}finally{if(a)throw n}}t.createSelectorQuery().select("#contain").boundingClientRect(function(e){t.triggerEvent("ready",e)}).exec()},50)}},properties:{html:{type:null,value:"",observer:function(t){var e={},a={};if(this.data.showWithAnimation&&(e=wx.createAnimation({duration:this.data.animationDuration,timingFunction:"ease"}).opacity(0).step().export(),a=wx.createAnimation({duration:this.data.animationDuration,timingFunction:"ease"}).opacity(1).step().export()),t)if("string"==typeof t){var o;this.data.cacheId?(App.globalData=App.globalData||{},App.globalData[this.data.cacheId]?o=App.globalData[this.data.cacheId]:(o=parseHtmlSync(t,this.data),App.globalData[this.data.cacheId]=o)):o=parseHtmlSync(t,this.data),this.setData({nodes:o.nodes,controls:{imgMode:this.data.imgMode},showAnimation:a,hideAnimation:e}),this.triggerEvent("parse",o),Document&&(this.document=new Document("nodes",o.nodes,this)),this._ready(o.title,o.imgList)}else if(t.constructor==Array)this.setData({controls:{imgMode:this.data.imgMode},showAnimation:a,hideAnimation:e}),Document&&(this.document=new Document("html",t,this)),this._ready();else if("object"==(void 0===t?"undefined":_typeof(t))){if(!t.nodes||t.nodes.constructor!=Array){if(t.name&&t.children&&t.attrs||"text"==t.type)return;return void this.triggerEvent("error",{source:"parse",errMsg:"传入的nodes数组格式不正确！应该传入的类型是array，实际传入的类型是："+_typeof(t.nodes)})}this.setData({controls:{imgMode:this.data.imgMode},showAnimation:a,hideAnimation:e}),Document&&(this.document=new Document("html.nodes",t.nodes,this)),this._ready(t.title,t.imgList)}else this.triggerEvent("error",{source:"parse",errMsg:"错误的html类型："+(void 0===t?"undefined":_typeof(t))});else this.setData({nodes:[]})}},autocopy:{type:Boolean,value:!0},autopause:{type:Boolean,value:!0},autopreview:{type:Boolean,value:!0},autosetTitle:{type:Boolean,value:!0},cacheId:{type:String,value:null},domain:{type:String,value:null},imgMode:{type:String,value:"default"},lazyLoad:{type:Boolean,value:!1},selectable:{type:Boolean,value:!1},tagStyle:{type:Object,value:{}},showWithAnimation:{type:Boolean,value:!1},animationDuration:{type:Number,value:400},useAnchor:{type:Boolean,value:!1}},methods:{_playVideo:function(t){if(this.videoContexts.length>1&&this.data.autopause){var e=!0,a=!1,o=void 0;try{for(var n,r=this.videoContexts[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var i=n.value;i.id!=t.detail&&i.context.pause()}}catch(t){a=!0,o=t}finally{try{!e&&r.return&&r.return()}finally{if(a)throw o}}}}}});