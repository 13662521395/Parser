/* Parser 富文本插件 https://github.com/jin-yufeng/Parser */
"use strict";function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function isBlankChar(t){return void 0!=t&&(" "==t||"\t"==t||"\r"==t||"\n"==t||"\v"==t||"\f"==t)}var _createClass=function(){function t(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,s,e){return s&&t(i.prototype,s),e&&t(i,e),i}}(),CssHandler=require("./CssHandler.js"),config=require("./config.js"),emoji;try{emoji=require("./emoji.js")}catch(t){}var MpHtmlParser=function(){function t(i){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=arguments[2];_classCallCheck(this,t),this.cb=e,this.CssHandler=new CssHandler(s.tagStyle),this.data=i,this.DOM=[],this.imgList=[],this._imgMode=s.imgMode,this.title="",this._attrName="",this._attrValue="",this._attrs={},this._domain=s.domain,this._protocol=s.domain?s.domain.includes("://")?this._domain.split("://")[0]:"http":void 0,this._i=0,this._sectionStart=0,this._stateHandler=this.TextHandler,this._STACK=[],this._tagName="",this._audioNum=0,this._videoNum=0,this._useAnchor=s.useAnchor,this._whiteSpace=!1}return _createClass(t,[{key:"parse",value:function(){for(this.CssHandler&&(this.data=this.CssHandler.getStyle(this.data));this._i<this.data.length;this._i++)this._stateHandler(this.data[this._i]);for(this._stateHandler==this.TextHandler&&this.setText();this._STACK.length;)this.popNode(this._STACK.pop());var t={abbr:!0,b:!0,big:!0,code:!0,del:!0,em:!0,font:!0,i:!0,ins:!0,label:!0,mark:!0,q:!0,s:!0,small:!0,span:!0,strong:!0,sub:!0,sup:!0,u:!0};!function i(s){var e=!0,a=!1,r=void 0;try{for(var h,n=s[Symbol.iterator]();!(e=(h=n.next()).done);e=!0){var l=h.value;if("text"!=l.type)if(l.continue)i(l.children);else{var o="",d=l.attrs.style,_=/float[^;]+(?![\s\S]*?float)/i;_.test(d)&&(o+=_.exec(d)[0]),_=/margin[^;]+/gi,_.test(d)&&(o+=";"+d.match(_).join(";")),_=/display\s*:\s*([^;]*)(?![\s\S]*?display)/i,_.test(d)&&"flex"!=_.exec(d)[1]?o+=";"+_.exec(d)[0]:t[l.name]?o+=";display:inline":o+=";display:"+("img"==l.name?"inline-block":"block"),_=/flex[^;]*:[^;]+/gi,_.test(d)&&(o+=";"+d.match(_).join(";")),_=/[^;\s]*width[^;]+/gi,_.test(d)&&(o+=";"+d.match(_).join(";")),l.attrs.containStyle=o,/[^-]width[^pev;]+/.test(";"+d)&&(l.attrs.style+=";width:100%");var c="";/margin\s*:/.test(d)?c=";margin:0":/margin-top/.test(d)?c=";margin-top:0":/margin-bottom/.test(d)&&(c=";margin-bottom:0"),l.attrs.style=(l.attrs.style||"").replace(/margin[^;]*/gi,""),l.attrs.style+=c}}}catch(t){a=!0,r=t}finally{try{!e&&n.return&&n.return()}finally{if(a)throw r}}}(this.DOM);var i={title:this.title,nodes:this.DOM,imgList:this.imgList};if(!this.cb)return i;this.cb(i)}},{key:"TextHandler",value:function(t){if("<"==t){var i=this.data[this._i+1];i>="a"&&i<="z"||i>="A"&&i<="Z"?(this.setText(),this._stateHandler=this.TagNameHandler):"/"==i?(this.setText(),this._i++,i=this.data[this._i+1],i>="a"&&i<="z"||i>="A"&&i<="Z"?(this._sectionStart=this._i+1,this._stateHandler=this.EndTagHandler):this._stateHandler=this.CommentHandler):"!"==i&&(this.setText(),this._stateHandler=this.CommentHandler)}}},{key:"CommentHandler",value:function(){if("--"==this.data.substring(this._i+1,this._i+3)||"[CDATA["==this.data.substring(this._i+1,this._i+7)){if(this._i=this.data.indexOf("--\x3e",this._i+1),-1==this._i)return this._i=this.data.length;this._i=this._i+2}else if(this._i=this.data.indexOf(">",this._i+1),-1==this._i)return this._i=this.data.length;this._sectionStart=this._i+1,this._stateHandler=this.TextHandler}},{key:"TagNameHandler",value:function(t){isBlankChar(t)?(this._tagName=this.getSelection(!0),this.checkClose()?this.setNode():this._stateHandler=this.AttrNameHandler):this.checkClose()&&(this._tagName=this.getSelection(),this.setNode())}},{key:"AttrNameHandler",value:function(t){if(isBlankChar(t))if(this._attrName=this.getSelection(!0),"="==this.data[this._i]){for(;isBlankChar(this.data[++this._i]););this._sectionStart=this._i,this._i--,this._stateHandler=this.AttrValueHandler}else this.setAttr();else if("="==t){for(this._attrName=this.getSelection();isBlankChar(this.data[++this._i]););this._sectionStart=this._i,this._i--,this._stateHandler=this.AttrValueHandler}else this.checkClose()&&(this._attrName=this.getSelection(),this.setAttr())}},{key:"AttrValueHandler",value:function(t){if('"'==t||"'"==t){if(this._sectionStart++,-1==(this._i=this.data.indexOf(t,this._i+1)))return this._i=this.data.length}else for(;!isBlankChar(this.data[this._i]&&"/"!=this.data[this._i]&&">"!=this.data[this._i]);this._i++);for(this._attrValue=this.getSelection();this._attrValue.includes("&quot;");)this._attrValue=this._attrValue.replace("&quot;","");this.setAttr()}},{key:"EndTagHandler",value:function(t){if(isBlankChar(t)||">"==t||"/"==t){for(var i=this.getSelection().toLowerCase(),s=!1,e=this._STACK.length-1;e>=0;e--)if(this._STACK[e].name==i){s=!0;break}if(s)for(var a;s;)a=this._STACK.pop(),a.name==i&&(s=!1),this.popNode(a);else if("p"==i||"br"==i){var r=this._STACK.length?this._STACK[this._STACK.length-1].children:this.DOM,a={name:i,attrs:{},children:[]};r.push(a)}this._i=this.data.indexOf(">",this._i),-1==this._i?this._i=this.data.length:this._stateHandler=this.TextHandler}}},{key:"checkClose",value:function(){return">"==this.data[this._i]||"/"==this.data[this._i]&&">"==this.data[this._i+1]}},{key:"getSelection",value:function(t){for(var i=this._sectionStart==this._i?"":this.data.substring(this._sectionStart,this._i);t&&isBlankChar(this.data[++this._i]););return t&&this._i--,this._sectionStart=this._i+1,i}},{key:"setAttr",value:function(){for(config.trustAttrs[this._attrName]&&(this._attrs[this._attrName]=this._attrValue||"true"),this._attrValue="";isBlankChar(this.data[this._i]);)this._i++;this.checkClose()?this.setNode():this._stateHandler=this.AttrNameHandler}},{key:"setText",value:function(){var t=this.getSelection();if(t){if(!this._whiteSpace){for(var i,s=!1,e=!1,a=0;a<t.length;a++)isBlankChar(t[a])?s||(i=a,s=!0):(e=!0,s&&(a-i>1&&(t=t.substring(0,i)+" "+t.substring(a)),a=i,s=!1));if(s&&(t=t.substring(0,i)+" "),!t||!e)return}emoji&&(t=emoji.parseEmoji(t));for(var r,h={lt:"<",gt:">",amp:"&",quot:'"',apos:"'",nbsp:" ",ensp:" ",emsp:" ",ndash:"–",mdash:"—",middot:"·",lsquo:"‘",rsquo:"’",ldquo:"“",rdquo:"”",bull:"•",hellip:"…",permil:"‰",copy:"©",reg:"®",trade:"™",times:"×",divide:"÷",cent:"￠",pound:"£",yen:"¥",euro:"€",sect:"§"},a=t.indexOf("&");-1!=a&&a<t.length;){if((r=t.indexOf(";",a))-a>=2&&r-a<=6){var n=t.substring(a+1,r);h[n]&&(t=t.substring(0,a)+h[n]+t.substring(r+1))}a=t.indexOf("&",a+1)}var l=this._STACK.length?this._STACK[this._STACK.length-1].children:this.DOM;if(l.length&&"text"==l[l.length-1].type)l[l.length-1].text+=t;else{var o={type:"text",text:t,decode:void 0};l.push(o)}}}},{key:"bubbling",value:function(){for(var t=this._STACK.length-1;t>=0;t--){if(0===config.trustTags[this._STACK[t].name])return this._STACK[t].name;this._STACK[t].continue=!0}}},{key:"setNode",value:function(){var t=this._STACK.length?this._STACK[this._STACK.length-1].children:this.DOM,i={name:this._tagName.toLowerCase(),attrs:this._attrs,children:[]};if(config.LabelAttrsHandler(i,this),this._useAnchor&&i.attrs.id&&this.bubbling(),this._attrs={},!config.selfClosingTags[this._tagName]){if(config.ignoreTags[i.name]||"title"==i.name){for(var s=++this._i;this._i<this.data.length;){if(this._i=this.data.indexOf("</",this._i),-1==this._i)return this._i=this.data.length;for(this._i+=2,this._sectionStart=this._i;!isBlankChar(this.data[this._i])&&">"!=this.data[this._i]&&"/"!=this.data[this._i];)this._i++;if(this.data.substring(this._sectionStart,this._i).toLowerCase()==i.name){"title"==i.name&&(this.title=this.data.substring(s,this._sectionStart-2)),this._i=this.data.indexOf(">",this._i),-1==this._i?this._i=this.data.length:this._sectionStart=this._i+1,this._stateHandler=this.TextHandler;break}}return}this._STACK.push(i),"pre"==i.name&&(this._whiteSapce=!0,i.pre=!0,config.highlight&&(this._sectionStart=this._i+1,this._i=this.data.indexOf("</pre",this._sectionStart),this.data=this.data.substring(0,this._sectionStart)+config.highlight(this.data.substring(this._sectionStart,this._i),i.attrs)+this.data.substring(this._i),this._i=this._sectionStart-1))}if(">"!=this.data[this._i]&&this._i++,this._sectionStart=this._i+1,this._stateHandler=this.TextHandler,!config.ignoreTags[i.name]){i.attrs.style=this.CssHandler.match(i.name,i.attrs,i)+(i.attrs.style||""),i.attrs.style||delete i.attrs.style;for(var e=i.attrs.style?i.attrs.style.toLowerCase().split(";"):[],a=0;a<e.length;a++)if(e[a].includes("white-space")&&e[a].includes("pre")){this._whiteSpace=!0,i.pre=!0;break}t.push(i)}}},{key:"popNode",value:function(t){if(config.blockTags[t.name]?t.name="div":config.trustTags.hasOwnProperty(t.name)||(t.name="span"),t.pre){this._whiteSpace=!1,delete t.pre;for(var i=0;i<this._STACK.length;i++)this._STACK[i].pre&&(this._whiteSpace=!0)}if("table"==t.name){if(t.attrs.style=t.attrs.style||"",t.attrs.border&&(t.attrs.style+=";border:"+t.attrs.border+"px solid gray;"),t.attrs.hasOwnProperty("cellspacing")&&(t.attrs.style+=";border-spacing:"+t.attrs.cellspacing+"px"),t.attrs.border||t.attrs.hasOwnProperty("cellpadding"))for(var i=0;i<t.children.length;i++)!function i(s){if("th"==s.name||"td"==s.name)return t.attrs.border&&(s.attrs.style=(s.attrs.style||"")+";border:"+t.attrs.border+"px solid gray;"),void(t.attrs.hasOwnProperty("cellpadding")&&(s.attrs.style=(s.attrs.style||"")+";padding:"+t.attrs.cellpadding+"px"));if("text"!=s.type)for(var e=0;e<s.children.length;e++)i(s.children[e])}(t.children[i])}if(1==t.children.length&&"div"==t.name&&"div"==t.children[0].name){var s=t.children[0];t.attrs.style=t.attrs.style||"",s.attrs.style=s.attrs.style||"",!(t.attrs.style.includes("padding")&&(t.attrs.style.includes("margin")||s.attrs.style.includes("margin"))&&t.attrs.style.includes("display")&&s.attrs.style.includes("display"))||t.attrs.id&&t.attrs.id||t.attrs.class&&s.attrs.class||(s.attrs.style.includes("padding")&&(s.attrs.style="box-sizing:border-box;"+s.attrs.style),t.attrs.style=t.attrs.style+";"+s.attrs.style,t.attrs.id=(s.attrs.id||"")+(t.attrs.id||""),t.attrs.class=(s.attrs.class||"")+(t.attrs.class||""),t.children=s.children)}this.CssHandler.pop&&this.CssHandler.pop(t)}}]),t}();module.exports={parseHtml:function(t,i){return new Promise(function(s){return new MpHtmlParser(t,i,s).parse()})},parseHtmlSync:function(t,i){return new MpHtmlParser(t,i).parse()}};